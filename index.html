<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dzikir & Doa Qurani</title>
    
    <!-- Fonts: Inter (UI) & Amiri (Arabic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        arabic: ['Amiri', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-short': 'pulseShort 0.2s ease-in-out',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseShort: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(0.95)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Islamic Pattern Background */
        .bg-islamic {
            background-color: #f9fafb;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23059669' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Arabic Text Adjustments */
        .arabic-text {
            line-height: 2.2;
            direction: rtl;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #059669;
            margin-top: -8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #d1fae5;
            border-radius: 2px;
        }

        /* App Container for Desktop View */
        body {
            background-color: #e5e7eb; /* Gray for desktop background */
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        #app-container {
            width: 100%;
            max-width: 480px;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height */
            background-color: white;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="font-sans text-gray-800">

    <!-- App Container -->
    <div id="app-container" class="bg-islamic">
        
        <!-- HEADER -->
        <header class="bg-emerald-600 text-white p-6 pb-12 rounded-b-[2rem] shadow-lg relative z-10 transition-all duration-300" id="main-header">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-moon text-yellow-300 text-xl"></i>
                    <h1 class="font-bold text-xl tracking-tight">DzikirApp</h1>
                </div>
                <button onclick="toggleSettings()" class="w-10 h-10 rounded-full bg-emerald-700 hover:bg-emerald-800 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
            
            <div id="greeting-section" class="animate-fade-in">
                <p id="greeting-text" class="text-emerald-100 text-sm font-medium mb-1">Assalamu'alaikum</p>
                <h2 id="hijri-date" class="text-2xl font-bold leading-tight">Memuat Tanggal...</h2>
                <div class="mt-4 bg-emerald-700/50 backdrop-blur-sm p-3 rounded-xl border border-emerald-500/30 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-emerald-200">Shalat Berikutnya</p>
                        <p id="next-prayer-name" class="font-bold text-lg">...</p>
                    </div>
                    <div class="text-right">
                        <p id="next-prayer-time" class="font-mono text-xl font-bold">--:--</p>
                        <p id="location-name" class="text-[10px] text-emerald-200"><i class="fa-solid fa-location-dot mr-1"></i>Lokasi...</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA (Scrollable) -->
        <main id="main-content" class="flex-1 overflow-y-auto overflow-x-hidden no-scrollbar relative -mt-8 pt-10 px-4 pb-24">
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="space-y-6 animate-fade-in">
                
                <!-- Random Verse Card -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-emerald-50">
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-quran text-emerald-500 text-xl mt-1"></i>
                        <div>
                            <p class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-1">Ayat Pilihan</p>
                            <p class="text-gray-700 italic text-sm leading-relaxed" id="random-verse-text">"Maka ingatlah kepada-Ku, Aku pun akan ingat kepadamu..."</p>
                            <p class="text-right text-xs text-emerald-600 font-bold mt-2" id="random-verse-ref">QS. Al-Baqarah: 152</p>
                        </div>
                    </div>
                </div>

                <!-- Menu Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Menu Item -->
                    <button onclick="openCategory('pagi')" class="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-emerald-200 transition-all active:scale-95 text-left group">
                        <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center mb-3 group-hover:bg-orange-500 group-hover:text-white transition-colors">
                            <i class="fa-regular fa-sun text-lg"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Dzikir Pagi</h3>
                        <p class="text-xs text-gray-500">Pembuka Rezeki</p>
                    </button>

                    <button onclick="openCategory('petang')" class="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-emerald-200 transition-all active:scale-95 text-left group">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center mb-3 group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                            <i class="fa-solid fa-cloud-moon text-lg"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Dzikir Petang</h3>
                        <p class="text-xs text-gray-500">Pelindung Diri</p>
                    </button>

                    <button onclick="openCategory('shalat')" class="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-emerald-200 transition-all active:scale-95 text-left group">
                        <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-500 flex items-center justify-center mb-3 group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                            <i class="fa-solid fa-person-praying text-lg"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Dzikir Shalat</h3>
                        <p class="text-xs text-gray-500">Setelah Fardhu</p>
                    </button>

                    <button onclick="openCategory('harian')" class="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-emerald-200 transition-all active:scale-95 text-left group">
                        <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-500 flex items-center justify-center mb-3 group-hover:bg-teal-500 group-hover:text-white transition-colors">
                            <i class="fa-solid fa-hands-holding-circle text-lg"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Doa Harian</h3>
                        <p class="text-xs text-gray-500">Aktivitas Sehari-hari</p>
                    </button>
                    
                     <button onclick="openCategory('favorit')" class="col-span-2 bg-gradient-to-r from-emerald-500 to-teal-500 p-4 rounded-2xl shadow-md text-white text-left active:scale-95 transition-transform relative overflow-hidden">
                        <div class="absolute right-0 bottom-0 opacity-20 transform translate-x-2 translate-y-2">
                             <i class="fa-solid fa-heart text-6xl"></i>
                        </div>
                        <div class="relative z-10 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                <i class="fa-solid fa-bookmark text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-bold">Favorit Saya</h3>
                                <p class="text-xs text-emerald-100">Kumpulan doa tersimpan</p>
                            </div>
                        </div>
                    </button>
                </div>

                <!-- Prayer Times List (Hidden by default, shown via API) -->
                <div id="prayer-list-container" class="bg-white p-4 rounded-2xl shadow-sm hidden">
                     <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">Jadwal Shalat Hari Ini</h3>
                     <div id="prayer-times-list" class="space-y-2 text-sm">
                         <!-- Injected by JS -->
                     </div>
                </div>
            </div>

            <!-- Slider/Reader View (Hidden by default) -->
            <div id="reader-view" class="hidden h-full flex flex-col relative">
                <!-- Navigation Header -->
                <div class="flex items-center justify-between mb-4 sticky top-0 bg-islamic z-10 py-2">
                    <button onclick="goHome()" class="text-gray-500 hover:text-emerald-600 w-8 h-8 flex items-center justify-center rounded-full active:bg-gray-200">
                        <i class="fa-solid fa-arrow-left text-xl"></i>
                    </button>
                    <div class="text-center">
                        <h2 id="reader-title" class="font-bold text-gray-800 text-lg">Judul Kategori</h2>
                        <span id="slide-indicator" class="text-xs text-emerald-600 font-medium bg-emerald-100 px-2 py-0.5 rounded-full">1 / 10</span>
                    </div>
                    <button id="btn-favorite" onclick="toggleFavorite()" class="text-gray-300 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full transition-colors active:scale-125">
                        <i class="fa-solid fa-heart text-xl"></i>
                    </button>
                </div>

                <!-- Card Slider Area -->
                <div class="flex-1 relative" id="slider-container">
                    <div id="content-card" class="bg-white rounded-3xl shadow-lg p-6 min-h-[400px] flex flex-col justify-between border border-gray-100 transition-all duration-300 transform">
                        <!-- Content Injected via JS -->
                        <div class="text-center animate-pulse mt-10">Memuat Data...</div>
                    </div>
                </div>

                <!-- Bottom Controls -->
                <div class="flex justify-between items-center mt-6 px-2">
                    <button onclick="prevSlide()" class="w-12 h-12 rounded-full bg-white text-emerald-600 shadow-md border border-gray-100 flex items-center justify-center active:bg-gray-50 disabled:opacity-50" id="btn-prev">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    
                    <!-- Tasbih Button (Dynamic) -->
                    <button id="btn-tasbih" onclick="countTasbih()" class="w-20 h-20 rounded-full bg-emerald-600 shadow-xl shadow-emerald-200 border-4 border-emerald-100 flex flex-col items-center justify-center text-white active:scale-95 transition-all">
                        <span id="tasbih-count" class="text-2xl font-bold">0</span>
                        <span id="tasbih-target" class="text-[10px] opacity-80">Target: 33</span>
                    </button>

                    <button onclick="nextSlide()" class="w-12 h-12 rounded-full bg-white text-emerald-600 shadow-md border border-gray-100 flex items-center justify-center active:bg-gray-50 disabled:opacity-50" id="btn-next">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>

        </main>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end justify-center backdrop-blur-sm transition-opacity">
            <div class="bg-white w-full max-w-[480px] rounded-t-3xl p-6 shadow-2xl animate-fade-in transform translate-y-0">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg text-gray-800">Pengaturan Tampilan</h3>
                    <button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-red-100 hover:text-red-500">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Arabic Font Size -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-gray-600">Ukuran Arab</label>
                            <span class="text-xs bg-emerald-100 text-emerald-700 px-2 rounded" id="label-arabic-size">24px</span>
                        </div>
                        <input type="range" min="18" max="48" value="24" id="range-arabic" class="w-full">
                        <p class="font-arabic text-center mt-3 text-emerald-800" id="preview-arabic" style="font-size: 24px;">اللَّهُ أَكْبَرُ</p>
                    </div>

                    <!-- Translation Font Size -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-gray-600">Ukuran Terjemahan</label>
                            <span class="text-xs bg-emerald-100 text-emerald-700 px-2 rounded" id="label-trans-size">14px</span>
                        </div>
                        <input type="range" min="10" max="24" value="14" id="range-trans" class="w-full">
                        <p class="text-center mt-3 text-gray-600" id="preview-trans" style="font-size: 14px;">Allah Maha Besar</p>
                    </div>
                </div>

                <button onclick="toggleSettings()" class="w-full mt-8 bg-emerald-600 text-white py-3 rounded-xl font-semibold active:scale-95 transition-transform">Simpan & Tutup</button>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA STORE (Fallback) ---
        const MOCK_DATA = {
            pagi: [
                { id: 'p1', arabic: "أَعُوذُ بِاللَّهِ مِنَ الشَّيْطَانِ الرَّجِيمِ<br/>اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ...", latin: "Allahu laa ilaaha illa huwal hayyul qayyum...", translation: "(Membaca Ayat Kursi)", count: 1, ref: "HR. An-Nasai" },
                { id: 'p2', arabic: "بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيْمِ<br/>قُلْ هُوَ ٱللَّهُ أَحَدٌ...", latin: "Qul huwallahu ahad...", translation: "Membaca Surah Al-Ikhlas, Al-Falaq, dan An-Naas (3x)", count: 3, ref: "HR. Abu Daud" },
                { id: 'p3', arabic: "أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَٰهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ...", latin: "Ash-bahna wa ash-bahal mulku lillah...", translation: "Kami telah memasuki waktu pagi dan kerajaan hanya milik Allah...", count: 1, ref: "HR. Muslim" }
            ],
            petang: [
                { id: 'e1', arabic: "أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ...", latin: "Amsayna wa amsayal mulku lillah...", translation: "Kami telah memasuki waktu petang dan kerajaan hanya milik Allah...", count: 1, ref: "HR. Muslim" },
                { id: 'e2', arabic: "اللَّهُمَّ بِكَ أَمْسَيْنَا وَبِكَ أَصْبَحْنَا...", latin: "Allahumma bika amsayna wa bika ashbahna...", translation: "Ya Allah, dengan rahmat-Mu kami berada di waktu sore...", count: 1, ref: "HR. Tirmidzi" }
            ],
            shalat: [
                { id: 's1', arabic: "أَسْتَغْفِرُ اللهَ (x3)", latin: "Astaghfirullah", translation: "Aku memohon ampun kepada Allah.", count: 3, ref: "HR. Muslim" },
                { id: 's2', arabic: "اللَّهُمَّ أَنْتَ السَّلاَمُ، وَمِنْكَ السَّلاَمُ...", latin: "Allahumma antas salaam...", translation: "Ya Allah, Engkau-lah As-Salam...", count: 1, ref: "HR. Muslim" },
                { id: 's3', arabic: "سُبْحَانَ اللهِ (x33)", latin: "Subhanallah", translation: "Maha Suci Allah", count: 33, ref: "HR. Muslim" },
                { id: 's4', arabic: "الْحَمْدُ لِلَّهِ (x33)", latin: "Alhamdulillah", translation: "Segala puji bagi Allah", count: 33, ref: "HR. Muslim" },
                { id: 's5', arabic: "اللَّهُ أَكْبَرُ (x33)", latin: "Allahu Akbar", translation: "Allah Maha Besar", count: 33, ref: "HR. Muslim" }
            ],
            harian: [
                { id: 'h1', arabic: "بِسْمِ اللَّهِ تَوَكَّلْتُ عَلَى اللَّهِ، لَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللَّهِ", latin: "Bismillahi tawakkaltu 'alallah...", translation: "Doa keluar rumah", count: 1, ref: "HR. Abu Daud" },
                { id: 'h2', arabic: "اللَّهُمَّ بَارِكْ لَنَا فِيمَا رَزَقْتَنَا وَقِنَا عَذَابَ النَّارِ", latin: "Allahumma barik lana...", translation: "Doa sebelum makan", count: 1, ref: "HR. Ibnu Sunni" }
            ]
        };

        // --- STATE MANAGEMENT ---
        let state = {
            currentCategory: null,
            currentIndex: 0,
            currentData: [],
            tasbihCount: 0,
            favorites: JSON.parse(localStorage.getItem('dzikir_favorites')) || [],
            settings: JSON.parse(localStorage.getItem('dzikir_settings')) || { arabicSize: 24, transSize: 14 }
        };

        // --- DOM ELEMENTS ---
        const els = {
            header: document.getElementById('main-header'),
            dashboard: document.getElementById('dashboard-view'),
            reader: document.getElementById('reader-view'),
            readerTitle: document.getElementById('reader-title'),
            card: document.getElementById('content-card'),
            slideIndicator: document.getElementById('slide-indicator'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next'),
            btnTasbih: document.getElementById('btn-tasbih'),
            tasbihCounter: document.getElementById('tasbih-count'),
            tasbihTarget: document.getElementById('tasbih-target'),
            btnFavorite: document.getElementById('btn-favorite'),
            modal: document.getElementById('settings-modal'),
            rangeArabic: document.getElementById('range-arabic'),
            rangeTrans: document.getElementById('range-trans')
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initGreeting();
            initPrayerTimes();
            applySettings();
            
            // Random Verse
            const verses = [
                { t: '"Ingatlah, hanya dengan mengingat Allah hati menjadi tenteram."', r: 'QS. Ar-Ra\'d: 28' },
                { t: '"Dan Tuhanmu berfirman: Berdoalah kepada-Ku, niscaya akan Kuperkenankan bagimu."', r: 'QS. Ghafir: 60' },
                { t: '"Maka bersabarlah kamu, sesungguhnya janji Allah itu benar."', r: 'QS. Ar-Rum: 60' }
            ];
            const rv = verses[Math.floor(Math.random() * verses.length)];
            document.getElementById('random-verse-text').innerText = rv.t;
            document.getElementById('random-verse-ref').innerText = rv.r;

            // Settings Listeners
            els.rangeArabic.addEventListener('input', (e) => {
                state.settings.arabicSize = e.target.value;
                document.getElementById('label-arabic-size').innerText = e.target.value + 'px';
                document.getElementById('preview-arabic').style.fontSize = e.target.value + 'px';
                applySettings(); // Realtime update
            });
            els.rangeTrans.addEventListener('input', (e) => {
                state.settings.transSize = e.target.value;
                document.getElementById('label-trans-size').innerText = e.target.value + 'px';
                document.getElementById('preview-trans').style.fontSize = e.target.value + 'px';
                applySettings();
            });
        });

        // --- NAVIGATION LOGIC ---
        function openCategory(category) {
            state.currentCategory = category;
            state.currentIndex = 0;
            state.tasbihCount = 0;

            if (category === 'favorit') {
                if (state.favorites.length === 0) {
                    alert("Belum ada doa favorit tersimpan.");
                    return;
                }
                state.currentData = state.favorites;
            } else {
                state.currentData = MOCK_DATA[category] || [];
            }

            // UI Switch
            els.header.classList.add('-translate-y-full', 'absolute'); // Hide header smoothly
            setTimeout(() => els.header.classList.add('hidden'), 300);
            
            els.dashboard.classList.add('hidden');
            els.reader.classList.remove('hidden');
            
            const titles = { pagi: "Dzikir Pagi", petang: "Dzikir Petang", shalat: "Dzikir Shalat", harian: "Doa Harian", favorit: "Favorit Saya" };
            els.readerTitle.innerText = titles[category] || "Bacaan";

            renderSlide();
        }

        function goHome() {
            els.header.classList.remove('hidden', 'absolute');
            setTimeout(() => els.header.classList.remove('-translate-y-full'), 10);
            
            els.reader.classList.add('hidden');
            els.dashboard.classList.remove('hidden');
        }

        // --- SLIDER ENGINE ---
        function renderSlide() {
            const item = state.currentData[state.currentIndex];
            const isFav = state.favorites.some(f => f.id === item.id);
            
            // Render Card Content
            els.card.innerHTML = `
                <div class="flex-1 flex flex-col justify-center items-center text-center animate-fade-in">
                    <div class="w-full mb-6">
                        <p class="font-arabic font-bold text-gray-800 arabic-text leading-loose" style="font-size: ${state.settings.arabicSize}px">
                            ${item.arabic}
                        </p>
                    </div>
                    <div class="w-full mb-4">
                        <p class="text-emerald-600 font-medium text-sm mb-1">Bacaan Latin:</p>
                        <p class="text-gray-600 italic" style="font-size: ${state.settings.transSize}px">${item.latin}</p>
                    </div>
                    <div class="w-full border-t pt-4">
                        <p class="text-gray-500" style="font-size: ${state.settings.transSize}px">${item.translation}</p>
                        <span class="inline-block mt-3 px-3 py-1 bg-gray-100 text-gray-400 text-[10px] rounded-full uppercase tracking-wide">${item.ref}</span>
                    </div>
                </div>
            `;

            // Update Controls
            els.slideIndicator.innerText = `${state.currentIndex + 1} / ${state.currentData.length}`;
            els.btnPrev.disabled = state.currentIndex === 0;
            els.btnNext.disabled = state.currentIndex === state.currentData.length - 1;
            
            // Favorite Button State
            if (isFav) {
                els.btnFavorite.classList.remove('text-gray-300');
                els.btnFavorite.classList.add('text-red-500');
                els.btnFavorite.innerHTML = '<i class="fa-solid fa-heart text-xl"></i>';
            } else {
                els.btnFavorite.classList.add('text-gray-300');
                els.btnFavorite.classList.remove('text-red-500');
                els.btnFavorite.innerHTML = '<i class="fa-regular fa-heart text-xl"></i>';
            }

            // Tasbih Reset
            state.tasbihCount = 0;
            updateTasbihUI(item.count);
        }

        function nextSlide() {
            if (state.currentIndex < state.currentData.length - 1) {
                state.currentIndex++;
                renderSlide();
            }
        }

        function prevSlide() {
            if (state.currentIndex > 0) {
                state.currentIndex--;
                renderSlide();
            }
        }

        // --- TASBIH LOGIC ---
        function updateTasbihUI(target) {
            els.tasbihCounter.innerText = state.tasbihCount;
            els.tasbihTarget.innerText = target > 1 ? `Target: ${target}` : "Baca 1x";
            
            // Check logic
            const btn = els.btnTasbih;
            if (target > 1) {
                btn.style.display = 'flex';
                if (state.tasbihCount >= target) {
                    btn.classList.remove('bg-emerald-600', 'shadow-emerald-200');
                    btn.classList.add('bg-emerald-400', 'shadow-none'); // Visual feedback done
                } else {
                    btn.classList.add('bg-emerald-600', 'shadow-emerald-200');
                    btn.classList.remove('bg-emerald-400', 'shadow-none');
                }
            } else {
                // If count is 1, simplify UI or keep it for consistency
                 els.tasbihTarget.innerText = "Selesai";
                 if(state.tasbihCount >= 1) {
                     // Keep UI
                 }
            }
        }

        function countTasbih() {
            const target = state.currentData[state.currentIndex].count;
            if (state.tasbihCount < target) {
                state.tasbihCount++;
                
                // Haptic Feedback
                if (navigator.vibrate) navigator.vibrate(30);
                
                // Animation
                els.btnTasbih.classList.add('scale-90');
                setTimeout(() => els.btnTasbih.classList.remove('scale-90'), 100);

                if (state.tasbihCount === target) {
                    if (navigator.vibrate) navigator.vibrate([50, 50, 50]); // Success vibration
                    // Auto next slide optional? No, let user decide.
                }
                updateTasbihUI(target);
            }
        }

        // --- SWIPE GESTURE ---
        let touchStartX = 0;
        let touchEndX = 0;
        const sliderContainer = document.getElementById('slider-container');

        sliderContainer.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
        sliderContainer.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const threshold = 50;
            if (touchEndX < touchStartX - threshold) nextSlide(); // Swipe Left
            if (touchEndX > touchStartX + threshold) prevSlide(); // Swipe Right
        }

        // --- FAVORITES SYSTEM ---
        function toggleFavorite() {
            const item = state.currentData[state.currentIndex];
            const index = state.favorites.findIndex(f => f.id === item.id);
            const icon = els.btnFavorite.querySelector('i');

            icon.classList.add('animate-pop'); // Animation

            if (index === -1) {
                state.favorites.push(item);
                els.btnFavorite.classList.replace('text-gray-300', 'text-red-500');
                els.btnFavorite.innerHTML = '<i class="fa-solid fa-heart text-xl"></i>';
            } else {
                state.favorites.splice(index, 1);
                els.btnFavorite.classList.replace('text-red-500', 'text-gray-300');
                els.btnFavorite.innerHTML = '<i class="fa-regular fa-heart text-xl"></i>';
                
                // If viewing favorite category, refresh logic needed (simplified here)
                if (state.currentCategory === 'favorit') {
                   // Ideally remove slide immediately, but simpler to just leave until reload
                }
            }
            
            localStorage.setItem('dzikir_favorites', JSON.stringify(state.favorites));
            setTimeout(() => icon.classList.remove('animate-pop'), 300);
        }

        // --- SETTINGS SYSTEM ---
        function toggleSettings() {
            const isHidden = els.modal.classList.contains('hidden');
            if (isHidden) {
                els.modal.classList.remove('hidden');
                // Set inputs to current state
                els.rangeArabic.value = state.settings.arabicSize;
                els.rangeTrans.value = state.settings.transSize;
                document.getElementById('label-arabic-size').innerText = state.settings.arabicSize + 'px';
                document.getElementById('label-trans-size').innerText = state.settings.transSize + 'px';
            } else {
                localStorage.setItem('dzikir_settings', JSON.stringify(state.settings));
                els.modal.classList.add('hidden');
                // Re-render current slide to apply changes if reader is open
                if (!els.reader.classList.contains('hidden')) renderSlide();
            }
        }

        function applySettings() {
            // Apply directly where needed or relying on renderSlide reading state
            document.documentElement.style.setProperty('--arabic-size', state.settings.arabicSize + 'px');
        }

        // --- UTILS: TIME & API ---
        function initGreeting() {
            const hour = new Date().getHours();
            let greet = "Selamat Pagi";
            if (hour >= 11) greet = "Selamat Siang";
            if (hour >= 15) greet = "Selamat Sore";
            if (hour >= 18) greet = "Selamat Malam";
            
            document.getElementById('greeting-text').innerText = `${greet}, Hamba Allah`;
            
            // Simple Hijri converter (Approximate)
            const date = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('hijri-date').innerText = date.toLocaleDateString('id-ID', options);
        }

        async function initPrayerTimes() {
            // Fallback default (Jakarta)
            const defaultCoords = { lat: -6.2088, lon: 106.8456 }; 
            
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => fetchPrayerTimes(pos.coords), 
                    err => fetchPrayerTimes({latitude: defaultCoords.lat, longitude: defaultCoords.lon}));
                } else {
                    fetchPrayerTimes({latitude: defaultCoords.lat, longitude: defaultCoords.lon});
                }
            } catch (e) { console.log("Geo Error", e); }
        }

        async function fetchPrayerTimes(coords) {
            const date = new Date();
            const url = `https://api.aladhan.com/v1/timings/${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}?latitude=${coords.latitude}&longitude=${coords.longitude}&method=20`; // Method 20: Kemenag RI mostly compatible
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                const timings = data.data.timings;
                
                // Update UI Header
                document.getElementById('location-name').innerHTML = `<i class="fa-solid fa-location-dot mr-1"></i>Lat: ${coords.latitude.toFixed(2)}, Long: ${coords.longitude.toFixed(2)}`;
                
                // Determine Next Prayer
                const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                const prayerNamesIndo = {'Fajr': 'Shubuh', 'Dhuhr': 'Dzuhur', 'Asr': 'Ashar', 'Maghrib': 'Maghrib', 'Isha': 'Isya'};
                
                let nextP = 'Fajr';
                let nowMin = date.getHours() * 60 + date.getMinutes();
                
                for (let p of prayerOrder) {
                    const [h, m] = timings[p].split(':').map(Number);
                    if (h * 60 + m > nowMin) {
                        nextP = p;
                        break;
                    }
                }
                
                document.getElementById('next-prayer-name').innerText = prayerNamesIndo[nextP];
                document.getElementById('next-prayer-time').innerText = timings[nextP];
                
            } catch (err) {
                console.error("API Error", err);
                document.getElementById('next-prayer-name').innerText = "Offline";
            }
        }
    </script>
</body>
</html>
